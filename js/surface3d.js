'use strict';

(function () {
  var Surface = function Surface(node) {
    var heightFunction,
        colorFunction,
        timer,
        timer,
        transformPrecalc = [];
    var displayWidth = 300,
        displayHeight = 300,
        zoom = 1;
    var trans;

    this.setZoom = function (zoomLevel) {
      zoom = zoomLevel;
      if (timer) clearTimeout(timer);
      timer = setTimeout(renderSurface);
    };
    var getHeights = function getHeights() {
      var data = node.datum();
      var t,
          output = [];
      var xlength = data.length;
      var ylength = data[0].length;
      for (var x = 0; x < xlength; x++) {
        output.push(t = []);
        for (var y = 0; y < ylength; y++) {
          var value = heightFunction(data[x][y], x, y);
          t.push(value);
        }
      }
      return output;
    };
    var transformPoint = function transformPoint(point) {
      var x = transformPrecalc[0] * point[0] + transformPrecalc[1] * point[1] + transformPrecalc[2] * point[2];
      var y = transformPrecalc[3] * point[0] + transformPrecalc[4] * point[1] + transformPrecalc[5] * point[2];
      var z = transformPrecalc[6] * point[0] + transformPrecalc[7] * point[1] + transformPrecalc[8] * point[2];
      return [x, y, z];
    };
    var getTransformedData = function getTransformedData() {
      var data = node.datum();
      if (!heightFunction) return [[]];
      var t,
          output = [];
      var heights = getHeights();
      var xlength = data.length;
      var ylength = data[0].length;
      for (var x = 0; x < xlength; x++) {
        output.push(t = []);
        for (var y = 0; y < ylength; y++) {
          t.push(transformPoint([(x - xlength / 2) / (xlength * 1.41) * displayWidth * zoom, heights[x][y] * zoom, (y - ylength / 2) / (ylength * 1.41) * displayWidth * zoom]));
        }
      }
      return output;
    };
    var renderSurface = function renderSurface() {
      var originalData = node.datum();
      var data = getTransformedData();
      var xlength = data.length;
      var ylength = data[0].length;
      var d0 = [];
      var idx = 0;
      for (var x = 0; x < xlength - 1; x++) {
        for (var y = 0; y < ylength - 1; y++) {
          var depth = data[x][y][2] + data[x + 1][y][2] + data[x + 1][y + 1][2] + data[x][y + 1][2];
          d0.push({
            path: 'M' + (data[x][y][0] + displayWidth / 2).toFixed(10) + ',' + (data[x][y][1] + displayHeight / 2).toFixed(10) + 'L' + (data[x + 1][y][0] + displayWidth / 2).toFixed(10) + ',' + (data[x + 1][y][1] + displayHeight / 2).toFixed(10) + 'L' + (data[x + 1][y + 1][0] + displayWidth / 2).toFixed(10) + ',' + (data[x + 1][y + 1][1] + displayHeight / 2).toFixed(10) + 'L' + (data[x][y + 1][0] + displayWidth / 2).toFixed(10) + ',' + (data[x][y + 1][1] + displayHeight / 2).toFixed(10) + 'Z',
            depth: depth, data: originalData[x][y]
          });
        }
      }
      d0.sort(function (a, b) {
        return b.depth - a.depth;
      });
      var dr = node.selectAll('path').data(d0);
      dr.enter().append('path');
      if (trans) {
        dr = dr.transition().delay(trans.delay()).duration(trans.duration());
      }
      dr.attr('d', function (d) {
        return d.path;
      });
      if (colorFunction) {
        dr.attr('fill', function (d) {
          return colorFunction(d.data);
        });
      }
      trans = false;
    };
    this.renderSurface = renderSurface;
    this.setTurtable = function (yaw, pitch) {
      var cosA = Math.cos(pitch);
      var sinA = Math.sin(pitch);
      var cosB = Math.cos(yaw);
      var sinB = Math.sin(yaw);
      transformPrecalc[0] = cosB;
      transformPrecalc[1] = 0;
      transformPrecalc[2] = sinB;
      transformPrecalc[3] = sinA * sinB;
      transformPrecalc[4] = cosA;
      transformPrecalc[5] = -sinA * cosB;
      transformPrecalc[6] = -sinB * cosA;
      transformPrecalc[7] = sinA;
      transformPrecalc[8] = cosA * cosB;
      if (timer) clearTimeout(timer);
      timer = setTimeout(renderSurface);
      return this;
    };
    this.setTurtable(0.5, 0.5);
    this.surfaceColor = function (callback) {
      colorFunction = callback;
      if (timer) clearTimeout(timer);
      timer = setTimeout(renderSurface);
      return this;
    };
    this.surfaceHeight = function (callback) {
      heightFunction = callback;
      if (timer) clearTimeout(timer);
      timer = setTimeout(renderSurface);
      return this;
    };
    this.transition = function () {
      var transition = d3.selection.prototype.transition.bind(node)();
      colourFunction = null;
      heightFunction = null;
      transition.surfaceHeight = this.surfaceHeight;
      transition.surfaceColor = this.surfaceColor;
      trans = transition;
      return transition;
    };
    this.setHeight = function (height) {
      if (height) displayHeight = height;
    };
    this.setWidth = function (width) {
      if (width) displayWidth = width;
    };
  };
  d3.selection.prototype.surface3D = function (width, height) {
    if (!this.node().__surface__) this.node().__surface__ = new Surface(this);
    var surface = this.node().__surface__;
    this.turntable = surface.setTurtable;
    this.surfaceColor = surface.surfaceColor;
    this.surfaceHeight = surface.surfaceHeight;
    this.zoom = surface.setZoom;
    surface.setHeight(height);
    surface.setWidth(width);
    this.transition = surface.transition.bind(surface);
    return this;
  };
})();
//# sourceMappingURL=data:application/json;base64,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LElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFDM0IsVUFBSSxFQUFFLEdBQUMsRUFBRSxDQUFDO0FBQ1YsVUFBSSxHQUFHLEdBQUMsQ0FBQyxDQUFDO0FBQ1YsV0FBSSxJQUFJLENBQUMsR0FBQyxDQUFDLEVBQUMsQ0FBQyxHQUFDLE9BQU8sR0FBQyxDQUFDLEVBQUMsQ0FBQyxFQUFFLEVBQUM7QUFDMUIsYUFBSSxJQUFJLENBQUMsR0FBQyxDQUFDLEVBQUMsQ0FBQyxHQUFDLE9BQU8sR0FBQyxDQUFDLEVBQUMsQ0FBQyxFQUFFLEVBQUM7QUFDMUIsY0FBSSxLQUFLLEdBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFDLElBQUksQ0FBQyxDQUFDLEdBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUMsSUFBSSxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUMxRSxZQUFFLENBQUMsSUFBSSxDQUFDO0FBQ04sZ0JBQUksRUFDRixHQUFHLEdBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUMsWUFBWSxHQUFDLENBQUMsQ0FBQSxDQUFFLE9BQU8sQ0FBQyxFQUFFLENBQUMsR0FBQyxHQUFHLEdBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUMsYUFBYSxHQUFDLENBQUMsQ0FBQSxDQUFFLE9BQU8sQ0FBQyxFQUFFLENBQUMsR0FDOUYsR0FBRyxHQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBQyxZQUFZLEdBQUMsQ0FBQyxDQUFBLENBQUUsT0FBTyxDQUFDLEVBQUUsQ0FBQyxHQUFDLEdBQUcsR0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUMsYUFBYSxHQUFDLENBQUMsQ0FBQSxDQUFFLE9BQU8sQ0FBQyxFQUFFLENBQUMsR0FDbEcsR0FBRyxHQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUMsWUFBWSxHQUFDLENBQUMsQ0FBQSxDQUFFLE9BQU8sQ0FBQyxFQUFFLENBQUMsR0FBQyxHQUFHLEdBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBQyxhQUFhLEdBQUMsQ0FBQyxDQUFBLENBQUUsT0FBTyxDQUFDLEVBQUUsQ0FBQyxHQUN0RyxHQUFHLEdBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFDLFlBQVksR0FBQyxDQUFDLENBQUEsQ0FBRSxPQUFPLENBQUMsRUFBRSxDQUFDLEdBQUMsR0FBRyxHQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBQyxhQUFhLEdBQUMsQ0FBQyxDQUFBLENBQUUsT0FBTyxDQUFDLEVBQUUsQ0FBQyxHQUFDLEdBQUc7QUFDeEcsaUJBQUssRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7V0FDdkMsQ0FBQyxDQUFDO1NBQ0o7T0FDRjtBQUNELFFBQUUsQ0FBQyxJQUFJLENBQUMsVUFBUyxDQUFDLEVBQUUsQ0FBQyxFQUFDO0FBQUMsZUFBTyxDQUFDLENBQUMsS0FB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Q0FBQyxZQUFZLEdBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQztBQUN2QyxRQUFJLENBQUMsYUFBYSxHQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUM7QUFDekMsUUFBSSxDQUFDLElBQUksR0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDO0FBQzFCLFdBQU8sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDMUIsV0FBTyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUN4QixRQUFJLENBQUMsVUFBVSxHQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ2pELFdBQU8sSUFBSSxDQUFDO0dBQ2IsQ0FBQztDQUNILENBQUEsRUFBRyxDQUFDIiwiZmlsZSI6InNyYy9qcy9zdXJmYWNlM2QuanMiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24oKXtcbiAgdmFyIFN1cmZhY2U9ZnVuY3Rpb24obm9kZSl7XG4gICAgdmFyIGhlaWdodEZ1bmN0aW9uLGNvbG9yRnVuY3Rpb24sdGltZXIsdGltZXIsdHJhbnNmb3JtUHJlY2FsYz1bXTtcbiAgICB2YXIgZGlzcGxheVdpZHRoPTMwMCwgZGlzcGxheUhlaWdodD0zMDAsIHpvb209MTtcbiAgICB2YXIgdHJhbnM7XG5cblxuICAgIHRoaXMuc2V0Wm9vbT1mdW5jdGlvbih6b29tTGV2ZWwpe1xuICAgICAgem9vbT16b29tTGV2ZWw7XG4gICAgICBpZih0aW1lcikgY2xlYXJUaW1lb3V0KHRpbWVyKTtcbiAgICAgIHRpbWVyPXNldFRpbWVvdXQocmVuZGVyU3VyZmFjZSk7XG4gICAgfTtcbiAgICB2YXIgZ2V0SGVpZ2h0cz1mdW5jdGlvbigpe1xuICAgICAgdmFyIGRhdGE9bm9kZS5kYXR1bSgpO1xuICAgICAgdmFyIHQsIG91dHB1dD1bXTtcbiAgICAgIHZhciB4bGVuZ3RoPWRhdGEubGVuZ3RoO1xuICAgICAgdmFyIHlsZW5ndGg9ZGF0YVswXS5sZW5ndGg7XG4gICAgICBmb3IodmFyIHg9MDt4PHhsZW5ndGg7eCsrKXtcbiAgICAgICAgb3V0cHV0LnB1c2godD1bXSk7XG4gICAgICAgIGZvcih2YXIgeT0wO3k8eWxlbmd0aDt5Kyspe1xuICAgICAgICAgICAgdmFyIHZhbHVlPWhlaWdodEZ1bmN0aW9uKGRhdGFbeF1beV0seCx5KTtcbiAgICAgICAgICAgIHQucHVzaCh2YWx1ZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBvdXRwdXQ7XG4gICAgfTtcbiAgICB2YXIgdHJhbnNmb3JtUG9pbnQ9ZnVuY3Rpb24ocG9pbnQpe1xuICAgICAgdmFyIHg9dHJhbnNmb3JtUHJlY2FsY1swXSpwb2ludFswXSt0cmFuc2Zvcm1QcmVjYWxjWzFdKnBvaW50WzFdK3RyYW5zZm9ybVByZWNhbGNbMl0qcG9pbnRbMl07XG4gICAgICB2YXIgeT10cmFuc2Zvcm1QcmVjYWxjWzNdKnBvaW50WzBdK3RyYW5zZm9ybVByZWNhbGNbNF0qcG9pbnRbMV0rdHJhbnNmb3JtUHJlY2FsY1s1XSpwb2ludFsyXTtcbiAgICAgIHZhciB6PXRyYW5zZm9ybVByZWNhbGNbNl0qcG9pbnRbMF0rdHJhbnNmb3JtUHJlY2FsY1s3XSpwb2ludFsxXSt0cmFuc2Zvcm1QcmVjYWxjWzhdKnBvaW50WzJdO1xuICAgICAgcmV0dXJuIFt4LHksel07XG4gICAgfTtcbiAgICB2YXIgZ2V0VHJhbnNmb3JtZWREYXRhPWZ1bmN0aW9uKCl7XG4gICAgICB2YXIgZGF0YT1ub2RlLmRhdHVtKCk7XG4gICAgICBpZighaGVpZ2h0RnVuY3Rpb24pIHJldHVybiBbW11dO1xuICAgICAgdmFyIHQsIG91dHB1dD1bXTtcbiAgICAgIHZhciBoZWlnaHRzPWdldEhlaWdodHMoKTtcbiAgICAgIHZhciB4bGVuZ3RoPWRhdGEubGVuZ3RoO1xuICAgICAgdmFyIHlsZW5ndGg9ZGF0YVswXS5sZW5ndGg7XG4gICAgICBmb3IodmFyIHg9MDt4PHhsZW5ndGg7eCsrKXtcbiAgICAgICAgb3V0cHV0LnB1c2godD1bXSk7XG4gICAgICAgIGZvcih2YXIgeT0wO3k8eWxlbmd0aDt5Kyspe1xuICAgICAgICAgIHQucHVzaCh0cmFuc2Zvcm1Qb2ludChbKHgteGxlbmd0aC8yKS8oeGxlbmd0aCoxLjQxKSpkaXNwbGF5V2lkdGgqem9vbSwgaGVpZ2h0c1t4XVt5XSp6b29tLCAoeS15bGVuZ3RoLzIpLyh5bGVuZ3RoKjEuNDEpKmRpc3BsYXlXaWR0aCp6b29tXSkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gb3V0cHV0O1xuICAgIH07XG4gICAgdmFyIHJlbmRlclN1cmZhY2U9ZnVuY3Rpb24oKXtcbiAgICAgIHZhciBvcmlnaW5hbERhdGE9bm9kZS5kYXR1bSgpO1xuICAgICAgdmFyIGRhdGE9Z2V0VHJhbnNmb3JtZWREYXRhKCk7XG4gICAgICB2YXIgeGxlbmd0aD1kYXRhLmxlbmd0aDtcbiAgICAgIHZhciB5bGVuZ3RoPWRhdGFbMF0ubGVuZ3RoO1xuICAgICAgdmFyIGQwPVtdO1xuICAgICAgdmFyIGlkeD0wO1xuICAgICAgZm9yKHZhciB4PTA7eDx4bGVuZ3RoLTE7eCsrKXtcbiAgICAgICAgZm9yKHZhciB5PTA7eTx5bGVuZ3RoLTE7eSsrKXtcbiAgICAgICAgICB2YXIgZGVwdGg9ZGF0YVt4XVt5XVsyXStkYXRhW3grMV1beV1bMl0rZGF0YVt4KzFdW3krMV1bMl0rZGF0YVt4XVt5KzFdWzJdO1xuICAgICAgICAgIGQwLnB1c2goe1xuICAgICAgICAgICAgcGF0aDpcbiAgICAgICAgICAgICAgJ00nKyhkYXRhW3hdW3ldWzBdK2Rpc3BsYXlXaWR0aC8yKS50b0ZpeGVkKDEwKSsnLCcrKGRhdGFbeF1beV1bMV0rZGlzcGxheUhlaWdodC8yKS50b0ZpeGVkKDEwKStcbiAgICAgICAgICAgICAgJ0wnKyhkYXRhW3grMV1beV1bMF0rZGlzcGxheVdpZHRoLzIpLnRvRml4ZWQoMTApKycsJysoZGF0YVt4KzFdW3ldWzFdK2Rpc3BsYXlIZWlnaHQvMikudG9GaXhlZCgxMCkrXG4gICAgICAgICAgICAgICdMJysoZGF0YVt4KzFdW3krMV1bMF0rZGlzcGxheVdpZHRoLzIpLnRvRml4ZWQoMTApKycsJysoZGF0YVt4KzFdW3krMV1bMV0rZGlzcGxheUhlaWdodC8yKS50b0ZpeGVkKDEwKStcbiAgICAgICAgICAgICAgJ0wnKyhkYXRhW3hdW3krMV1bMF0rZGlzcGxheVdpZHRoLzIpLnRvRml4ZWQoMTApKycsJysoZGF0YVt4XVt5KzFdWzFdK2Rpc3BsYXlIZWlnaHQvMikudG9GaXhlZCgxMCkrJ1onLFxuICAgICAgICAgICAgZGVwdGg6IGRlcHRoLCBkYXRhOiBvcmlnaW5hbERhdGFbeF1beV1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgZDAuc29ydChmdW5jdGlvbihhLCBiKXtyZXR1cm4gYi5kZXB0aC1hLmRlcHRofSk7XG4gICAgICB2YXIgZHI9bm9kZS5zZWxlY3RBbGwoJ3BhdGgnKS5kYXRhKGQwKTtcbiAgICAgIGRyLmVudGVyKCkuYXBwZW5kKFwicGF0aFwiKTtcbiAgICAgIGlmKHRyYW5zKXtcbiAgICAgICAgZHI9ZHIudHJhbnNpdGlvbigpLmRlbGF5KHRyYW5zLmRlbGF5KCkpLmR1cmF0aW9uKHRyYW5zLmR1cmF0aW9uKCkpO1xuICAgICAgfVxuICAgICAgZHIuYXR0cihcImRcIixmdW5jdGlvbihkKXtyZXR1cm4gZC5wYXRoO30pO1xuICAgICAgaWYoY29sb3JGdW5jdGlvbil7XG4gICAgICAgIGRyLmF0dHIoXCJmaWxsXCIsZnVuY3Rpb24oZCl7cmV0dXJuIGNvbG9yRnVuY3Rpb24oZC5kYXRhKX0pO1xuICAgICAgfVxuICAgICAgdHJhbnM9ZmFsc2U7XG4gICAgfTtcbiAgICB0aGlzLnJlbmRlclN1cmZhY2U9cmVuZGVyU3VyZmFjZTtcbiAgICB0aGlzLnNldFR1cnRhYmxlPWZ1bmN0aW9uKHlhdywgcGl0Y2gpe1xuICAgICAgdmFyIGNvc0E9TWF0aC5jb3MocGl0Y2gpO1xuICAgICAgdmFyIHNpbkE9TWF0aC5zaW4ocGl0Y2gpO1xuICAgICAgdmFyIGNvc0I9TWF0aC5jb3MoeWF3KTtcbiAgICAgIHZhciBzaW5CPU1hdGguc2luKHlhdyk7XG4gICAgICB0cmFuc2Zvcm1QcmVjYWxjWzBdPWNvc0I7XG4gICAgICB0cmFuc2Zvcm1QcmVjYWxjWzFdPTA7XG4gICAgICB0cmFuc2Zvcm1QcmVjYWxjWzJdPXNpbkI7XG4gICAgICB0cmFuc2Zvcm1QcmVjYWxjWzNdPXNpbkEqc2luQjtcbiAgICAgIHRyYW5zZm9ybVByZWNhbGNbNF09Y29zQTtcbiAgICAgIHRyYW5zZm9ybVByZWNhbGNbNV09LXNpbkEqY29zQjtcbiAgICAgIHRyYW5zZm9ybVByZWNhbGNbNl09LXNpbkIqY29zQTtcbiAgICAgIHRyYW5zZm9ybVByZWNhbGNbN109c2luQTtcbiAgICAgIHRyYW5zZm9ybVByZWNhbGNbOF09Y29zQSpjb3NCO1xuICAgICAgaWYodGltZXIpIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgICB0aW1lcj1zZXRUaW1lb3V0KHJlbmRlclN1cmZhY2UpO1xuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfTtcbiAgICB0aGlzLnNldFR1cnRhYmxlKDAuNSwwLjUpO1xuICAgIHRoaXMuc3VyZmFjZUNvbG9yPWZ1bmN0aW9uKGNhbGxiYWNrKXtcbiAgICAgIGNvbG9yRnVuY3Rpb249Y2FsbGJhY2s7XG4gICAgICBpZih0aW1lcikgY2xlYXJUaW1lb3V0KHRpbWVyKTtcbiAgICAgIHRpbWVyPXNldFRpbWVvdXQocmVuZGVyU3VyZmFjZSk7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9O1xuICAgIHRoaXMuc3VyZmFjZUhlaWdodD1mdW5jdGlvbihjYWxsYmFjayl7XG4gICAgICBoZWlnaHRGdW5jdGlvbj1jYWxsYmFjaztcbiAgICAgIGlmKHRpbWVyKSBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgdGltZXI9c2V0VGltZW91dChyZW5kZXJTdXJmYWNlKTtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH07XG4gICAgdGhpcy50cmFuc2l0aW9uPWZ1bmN0aW9uKCl7XG4gICAgICB2YXIgdHJhbnNpdGlvbj1kMy5zZWxlY3Rpb24ucHJvdG90eXBlLnRyYW5zaXRpb24uYmluZChub2RlKSgpO1xuICAgICAgY29sb3VyRnVuY3Rpb249bnVsbDtcbiAgICAgIGhlaWdodEZ1bmN0aW9uPW51bGw7XG4gICAgICB0cmFuc2l0aW9uLnN1cmZhY2VIZWlnaHQ9dGhpcy5zdXJmYWNlSGVpZ2h0O1xuICAgICAgdHJhbnNpdGlvbi5zdXJmYWNlQ29sb3I9dGhpcy5zdXJmYWNlQ29sb3I7XG4gICAgICB0cmFucz10cmFuc2l0aW9uO1xuICAgICAgcmV0dXJuIHRyYW5zaXRpb247XG4gICAgfTtcbiAgICB0aGlzLnNldEhlaWdodD1mdW5jdGlvbihoZWlnaHQpe1xuICAgICAgaWYoaGVpZ2h0KSBkaXNwbGF5SGVpZ2h0PWhlaWdodDtcbiAgICB9O1xuICAgIHRoaXMuc2V0V2lkdGg9ZnVuY3Rpb24od2lkdGgpe1xuICAgICAgaWYod2lkdGgpIGRpc3BsYXlXaWR0aD13aWR0aDtcbiAgICB9O1xuICB9O1xuICBkMy5zZWxlY3Rpb24ucHJvdG90eXBlLnN1cmZhY2UzRD1mdW5jdGlvbih3aWR0aCxoZWlnaHQpe1xuICAgIGlmKCF0aGlzLm5vZGUoKS5fX3N1cmZhY2VfXykgdGhpcy5ub2RlKCkuX19zdXJmYWNlX189bmV3IFN1cmZhY2UodGhpcyk7XG4gICAgdmFyIHN1cmZhY2U9dGhpcy5ub2RlKCkuX19zdXJmYWNlX187XG4gICAgdGhpcy50dXJudGFibGU9c3VyZmFjZS5zZXRUdXJ0YWJsZTtcbiAgICB0aGlzLnN1cmZhY2VDb2xvcj1zdXJmYWNlLnN1cmZhY2VDb2xvcjtcbiAgICB0aGlzLnN1cmZhY2VIZWlnaHQ9c3VyZmFjZS5zdXJmYWNlSGVpZ2h0O1xuICAgIHRoaXMuem9vbT1zdXJmYWNlLnNldFpvb207XG4gICAgc3VyZmFjZS5zZXRIZWlnaHQoaGVpZ2h0KTtcbiAgICBzdXJmYWNlLnNldFdpZHRoKHdpZHRoKTtcbiAgICB0aGlzLnRyYW5zaXRpb249c3VyZmFjZS50cmFuc2l0aW9uLmJpbmQoc3VyZmFjZSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH07XG59KSgpO1xuIl19
